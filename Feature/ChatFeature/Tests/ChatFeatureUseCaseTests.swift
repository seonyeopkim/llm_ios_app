// ğŸ¤– Generated by Xcode Coding Intelligence powered by Claude Sonnet 4
// ğŸ§‘ Reviewed and modified by human

@testable import ChatFeature
import LanguageModelClientTesting
import Testing

@Suite("ChatFeatureUseCase")
struct ChatFeatureUseCaseTests {
    @Test("ì‘ë‹µ ìŠ¤íŠ¸ë¦¼ì´ ì—ëŸ¬ë¥¼ ì •ìƒì ìœ¼ë¡œ ì „íŒŒí•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸")
    func testStreamResponseWithError() async throws {
        // Given
        let mockClient = MockLanguageModelClient(shouldThrowError: true)
        let useCase = ChatFeatureUseCase(repository: mockClient)
        let prompt = "í”„ë¡¬í”„íŠ¸"
        
        // When & Then
        await #expect(throws: MockLanguageModelError.self) {
            for try await _ in useCase.streamResponse(to: prompt) {}
        }
    }
    
    @Test("ë¹ˆ ì‘ë‹µ ìŠ¤íŠ¸ë¦¼ í…ŒìŠ¤íŠ¸")
    func testStreamResponseWithEmptyResponse() async throws {
        // Given
        let mockClient = MockLanguageModelClient(tokens: [])
        let useCase = ChatFeatureUseCase(repository: mockClient)
        let prompt = "í”„ë¡¬í”„íŠ¸"
        
        // When
        var receivedResponses = [String]()
        for try await response in useCase.streamResponse(to: prompt) {
            receivedResponses.append(response)
        }
        
        // Then
        #expect(receivedResponses.isEmpty, "ë¹ˆ ì‘ë‹µ ìŠ¤íŠ¸ë¦¼ì˜ ê²½ìš° ë°›ì€ ì‘ë‹µë„ ë¹„ì–´ìˆì–´ì•¼ í•©ë‹ˆë‹¤.")
    }
    
    @Test("ë‹¨ì¼ í† í° ì‘ë‹µ ìŠ¤íŠ¸ë¦¼ í…ŒìŠ¤íŠ¸")
    func testStreamResponseWithSingleToken() async throws {
        // Given
        let singleToken = "ë‹¨ì¼í† í°"
        let mockClient = MockLanguageModelClient(tokens: [singleToken])
        let useCase = ChatFeatureUseCase(repository: mockClient)
        let prompt = "í”„ë¡¬í”„íŠ¸"
        
        // When
        var receivedResponses = [String]()
        for try await response in useCase.streamResponse(to: prompt) {
            receivedResponses.append(response)
        }
        
        // Then
        #expect(receivedResponses == [singleToken], "ë°›ì€ ì‘ë‹µì´ ê¸°ëŒ€í•˜ëŠ” ì‘ë‹µê³¼ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.")
    }
    
    @Test("ë§ì€ í† í° ìˆ˜ì˜ ì‘ë‹µ ìŠ¤íŠ¸ë¦¼ í…ŒìŠ¤íŠ¸")
    func testStreamResponseWithLargeNumberOfTokens() async throws {
        // Given
        let largeNumberOfTokens = Array(1...100).map { "í† í°\($0)" }
        let mockClient = MockLanguageModelClient(
            tokens: largeNumberOfTokens,
            delayBetweenTokens: 0.01
        )
        let useCase = ChatFeatureUseCase(repository: mockClient)
        let prompt = "í”„ë¡¬í”„íŠ¸"
        
        // When
        var receivedResponses = [String]()
        for try await response in useCase.streamResponse(to: prompt) {
            receivedResponses.append(response)
        }
        
        // Then
        let expectedResponses = largeNumberOfTokens.toLanguageModelResponses()
        #expect(receivedResponses == expectedResponses, "ë°›ì€ ì‘ë‹µë“¤ì´ ê¸°ëŒ€í•˜ëŠ” ì‘ë‹µë“¤ê³¼ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.")
    }
}
